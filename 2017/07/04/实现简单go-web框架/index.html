<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>实现简单go web框架 | 你是猴子请来的逗比吗</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="使用Golang构建web服务还是比较简单的，使用net/http和gorilla/mux就能快速的构建一个简易的web server123456789101112package mainimport &amp;#123;    &quot;net/http&quot;    &quot;github.com/gorilla/mux&quot;&amp;#125;func main() &amp;#123;    router = mux.NewRouter(">
<meta name="keywords" content="golang,web,framework,rest">
<meta property="og:type" content="article">
<meta property="og:title" content="实现简单go web框架">
<meta property="og:url" content="http://nishihouziqinglaidedoubima.github.io/2017/07/04/实现简单go-web框架/index.html">
<meta property="og:site_name" content="你是猴子请来的逗比吗">
<meta property="og:description" content="使用Golang构建web服务还是比较简单的，使用net/http和gorilla/mux就能快速的构建一个简易的web server123456789101112package mainimport &amp;#123;    &quot;net/http&quot;    &quot;github.com/gorilla/mux&quot;&amp;#125;func main() &amp;#123;    router = mux.NewRouter(">
<meta property="og:image" content="http://nishihouziqinglaidedoubima.github.io/img/golang.jpg">
<meta property="og:updated_time" content="2019-02-22T11:34:51.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="实现简单go web框架">
<meta name="twitter:description" content="使用Golang构建web服务还是比较简单的，使用net/http和gorilla/mux就能快速的构建一个简易的web server123456789101112package mainimport &amp;#123;    &quot;net/http&quot;    &quot;github.com/gorilla/mux&quot;&amp;#125;func main() &amp;#123;    router = mux.NewRouter(">
<meta name="twitter:image" content="http://nishihouziqinglaidedoubima.github.io/img/golang.jpg">
  
    <link rel="alternate" href="/atom.xml" title="你是猴子请来的逗比吗" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">你是猴子请来的逗比吗</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">初九：素履，往无咎。</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://nishihouziqinglaidedoubima.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-实现简单go-web框架" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/07/04/实现简单go-web框架/" class="article-date">
  <time datetime="2017-07-04T07:56:07.000Z" itemprop="datePublished">2017-07-04</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/技术/">技术</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      实现简单go web框架
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="/img/golang.jpg" alt="FLYING"><br>使用Golang构建web服务还是比较简单的，使用net/http和gorilla/mux就能快速的构建一个简易的web server<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> main</div><div class="line"></div><div class="line"><span class="keyword">import</span> &#123;</div><div class="line">    <span class="string">"net/http"</span></div><div class="line">    <span class="string">"github.com/gorilla/mux"</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">    router = mux.NewRouter().StrictSlash(<span class="literal">true</span>)</div><div class="line">    router.Handle(<span class="string">"/"</span>, http.FileServer(http.Dir(<span class="string">"/static"</span>)))</div><div class="line">    http.ListenAndServe(<span class="string">":8080"</span>, <span class="literal">nil</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<a id="more"></a>
<p>这样一个简易的静态服务器就构建成功了。</p>
<p>当然我们不可能就这么满足了，我们当然希望这个服务器是可以处理一些业务逻辑的。比如登录：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">router.HandleFunc(<span class="string">"/login"</span>, handlers.LoginHandler)</div></pre></td></tr></table></figure></p>
<p>handler怎么写呢：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoginHandler</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">    controllers.LoginIndexAction(w,r);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>controller(使用mymysql连接数据库)：<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">LoginAction</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">    w.Header().Set(<span class="string">"content-type"</span>, <span class="string">"application/json"</span>)</div><div class="line">    err := r.ParseForm()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        Response(w, <span class="string">"Param error."</span>, <span class="string">"PARAM_ERROR"</span>,<span class="number">403</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line">    admin_name      := r.FormValue(<span class="string">"admin_name"</span>)</div><div class="line">    admin_password  := r.FormValue(<span class="string">"admin_password"</span>)</div><div class="line">    <span class="keyword">if</span> admin_name == <span class="string">""</span> || admin_password == <span class="string">""</span>&#123;</div><div class="line">        Response(w, <span class="string">"Param error."</span>, <span class="string">"PARAM_ERROR"</span>,<span class="number">403</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    db := mysql.New(<span class="string">"tcp"</span>, <span class="string">""</span>, <span class="string">"127.0.0.1:3306"</span>, <span class="string">"user"</span>, <span class="string">"pass"</span>, <span class="string">"database"</span>)</div><div class="line">    <span class="keyword">if</span> err := db.Connect(); err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Println(err)</div><div class="line">        Response(w, <span class="string">"Param error."</span>, <span class="string">"PARAM_ERROR"</span>,<span class="number">403</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">defer</span> db.Close()</div><div class="line"></div><div class="line">    rows, res, err := db.Query(<span class="string">"select * from webdemo_admin where admin_name = '%s'"</span>, admin_name)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        log.Println(err)</div><div class="line">        Response(w, <span class="string">"Database error."</span>, <span class="string">"DATABASE_ERROR"</span>,<span class="number">503</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    name := res.Map(<span class="string">"admin_password"</span>)</div><div class="line">    admin_password_db := rows[<span class="number">0</span>].Str(name)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> admin_password_db != admin_password &#123;</div><div class="line">        Response(w, <span class="string">"Password error."</span>, <span class="string">"PASSWORD_ERROR"</span>,<span class="number">403</span>)</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    cookie := http.Cookie&#123;Name: <span class="string">"admin_name"</span>, Value: rows[<span class="number">0</span>].Str(res.Map(<span class="string">"admin_name"</span>)), Path: <span class="string">"/"</span>&#125;</div><div class="line"></div><div class="line">    http.SetCookie(w, &amp;cookie)</div><div class="line">    Response(w, <span class="string">"Login success."</span>, <span class="string">"SUCCESS"</span>,<span class="number">200</span>)</div><div class="line">    <span class="keyword">return</span></div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> response <span class="keyword">struct</span>&#123;</div><div class="line">    Status <span class="keyword">int</span> <span class="string">`json:"status"`</span></div><div class="line">    Description <span class="keyword">string</span> <span class="string">`json:"description"`</span></div><div class="line">    Code <span class="keyword">string</span> <span class="string">`json:"code"`</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Response</span><span class="params">(w http.ResponseWriter, description <span class="keyword">string</span>,code <span class="keyword">string</span>, status <span class="keyword">int</span>)</span></span> &#123;</div><div class="line">    out := &amp;response&#123;status, description, code&#125;</div><div class="line">    b, err := json.Marshal(out)</div><div class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">        <span class="keyword">return</span></div><div class="line">    &#125;</div><div class="line">    w.WriteHeader(status)</div><div class="line">    w.Write(b)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>将用户名放到cookie里就当登录成功了。</p>
<p>如果有多个路由需要处理呢，情形就会变成这样：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.HandleFunc(<span class="string">"/url1"</span>, handlers.Handler1)</div><div class="line">router.HandleFunc(<span class="string">"/url2"</span>, handlers.Handler1)</div><div class="line">router.HandleFunc(<span class="string">"/url3"</span>, handlers.Handler1)</div><div class="line">router.HandleFunc(<span class="string">"/url4"</span>, handlers.Handler1)</div><div class="line">router.HandleFunc(<span class="string">"/url5"</span>, handlers.Handler1)</div><div class="line">router.HandleFunc(<span class="string">"/url6"</span>, handlers.Handler1)</div><div class="line">router.HandleFunc(<span class="string">"/url7"</span>, handlers.Handler1)</div><div class="line">...</div></pre></td></tr></table></figure>
<p>好像也无伤大雅，但是如果有更一步的需求，每个URL需要做权限验证，记录日志，这种方式显然就不太合理了，我们需要对router做统一的管理，这里我们跳过了handler层，直接由controller来处理，我觉得更简洁一点。<br><figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//先定义Route的结构体</span></div><div class="line"><span class="keyword">type</span> Route <span class="keyword">struct</span> &#123;</div><div class="line">	Name        <span class="keyword">string</span></div><div class="line">	Method      <span class="keyword">string</span></div><div class="line">	Pattern     <span class="keyword">string</span></div><div class="line">	Auth		<span class="keyword">bool</span></div><div class="line">	HandlerFunc http.HandlerFunc</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Routes []Route</div><div class="line"></div><div class="line"><span class="keyword">var</span> routes = Routes&#123;</div><div class="line">	Route&#123;</div><div class="line">		<span class="string">"url1"</span>,</div><div class="line">		<span class="string">"GET"</span>,</div><div class="line">		<span class="string">"/url1"</span>,</div><div class="line">		<span class="literal">true</span>,</div><div class="line">		controllers.Url1,</div><div class="line">	&#125;,</div><div class="line">	Route&#123;</div><div class="line">		<span class="string">"url2"</span>,</div><div class="line">		<span class="string">"POST"</span>,</div><div class="line">		<span class="string">"/url2"</span>,</div><div class="line">		<span class="literal">false</span>,</div><div class="line">		controllers.Url2,</div><div class="line">	&#125;,</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> router *mux.Router</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRouter</span><span class="params">()</span> *<span class="title">mux</span>.<span class="title">Router</span></span> &#123;</div><div class="line">        <span class="keyword">if</span> router == <span class="literal">nil</span> &#123;</div><div class="line">                router = mux.NewRouter().StrictSlash(<span class="literal">true</span>)</div><div class="line">        &#125;</div><div class="line">	<span class="keyword">for</span> _, route := <span class="keyword">range</span> routes &#123;</div><div class="line">		router.</div><div class="line">			Methods(route.Method).</div><div class="line">			Path(route.Pattern).</div><div class="line">			Name(route.Name).</div><div class="line">			Handler(route.HandlerFunc)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> router</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这时候如果添加权限验证，只有通过登录验证的用户才有权限调用，这就需要中间件（我个人比较喜欢称它装饰器）出场了：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Auth</span><span class="params">(inner http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">	    cookie, err := r.Cookie(<span class="string">"admin_name"</span>)</div><div class="line">	    <span class="keyword">if</span> err != <span class="literal">nil</span> || cookie.Value == <span class="string">""</span>&#123;</div><div class="line">	        Response(w, <span class="string">"token not found."</span>, <span class="string">"AUTH_FAILED"</span>,<span class="number">403</span>)</div><div class="line">	        <span class="keyword">return</span>;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    rows, res, err := db.Query(<span class="string">"select * from user where user_name= '%d'"</span>, cookie.Value)</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	        Response(w, <span class="string">"can not connect database."</span>, <span class="string">"DB_ERROR"</span>,<span class="number">500</span>)</div><div class="line">	        <span class="keyword">return</span></div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> <span class="built_in">len</span>(rows) == <span class="number">0</span> &#123;</div><div class="line">	    	Response(w, <span class="string">"user not found."</span>, <span class="string">"NOT_FOUND"</span>,<span class="number">404</span>)</div><div class="line">	    	<span class="keyword">return</span></div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    row := rows[<span class="number">0</span>]</div><div class="line"></div><div class="line">	    user := controllers.User&#123;</div><div class="line">	    		User_id:row.Int(res.Map(<span class="string">"user_id"</span>)), </div><div class="line">	    		User_name:row.Str(res.Map(<span class="string">"user_name"</span>)),</div><div class="line">	    		User_type:row.Str(res.Map(<span class="string">"user_type"</span>)),</div><div class="line">	    		Add_time:row.Str(res.Map(<span class="string">"add_time"</span>))&#125;</div><div class="line">	    session.CurrentUser = user</div><div class="line">	    log.Printf(<span class="string">"user_id:%v"</span>,controllers.CurrentUser.User_id)</div><div class="line">	    inner.ServeHTTP(w, r)</div><div class="line">	&#125;)</div><div class="line">&#125;</div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRouter</span><span class="params">()</span> *<span class="title">mux</span>.<span class="title">Router</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> router == <span class="literal">nil</span> &#123;</div><div class="line">                router = mux.NewRouter().StrictSlash(<span class="literal">true</span>)</div><div class="line">        &#125;</div><div class="line">	<span class="keyword">for</span> _, route := <span class="keyword">range</span> routes &#123;</div><div class="line">		<span class="keyword">if</span>(route.Auth)&#123;</div><div class="line">			handler = decorates.Auth(route.HandlerFunc)</div><div class="line"></div><div class="line">		&#125;</div><div class="line">		router.</div><div class="line">			Methods(route.Method).</div><div class="line">			Path(route.Pattern).</div><div class="line">			Name(route.Name).</div><div class="line">			Handler(handler)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> router</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>显然这样管理session是比较粗糙的，怎么办，有现成的解决方案，jwt(JSON Web Tokens)，我们可以使用jwt-go来生成token，如果一个请求cookie或者header里面含有token，并且可以验证通过，我就认为这个用户是合法用户：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//生成token</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Generate</span><span class="params">(key <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	token := jwt.NewWithClaims(jwt.SigningMethodHS256, jwt.MapClaims&#123;</div><div class="line">		<span class="string">"key"</span>: key,</div><div class="line">		<span class="string">"exp"</span>: (time.Now().Add(time.Minute * <span class="number">60</span> * <span class="number">24</span> * <span class="number">2</span>)).Unix(),</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	tokenString, err := token.SignedString(settings.HmacSampleSecret)</div><div class="line">	<span class="keyword">return</span> tokenString, err</div><div class="line">&#125;</div><div class="line"><span class="comment">//验证token</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Valid</span><span class="params">(tokenString <span class="keyword">string</span>)</span> <span class="params">(<span class="keyword">string</span>, error)</span></span> &#123;</div><div class="line">	token1, err := jwt.Parse(tokenString, <span class="function"><span class="keyword">func</span><span class="params">(token *jwt.Token)</span> <span class="params">(<span class="keyword">interface</span>&#123;&#125;, error)</span></span> &#123;</div><div class="line">		<span class="keyword">if</span> _, ok := token.Method.(*jwt.SigningMethodHMAC); !ok &#123;</div><div class="line">			<span class="keyword">return</span> <span class="literal">nil</span>, fmt.Errorf(<span class="string">"Unexpected signing method: %v"</span>, token.Header[<span class="string">"alg"</span>])</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">return</span> settings.HmacSampleSecret, <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line"></div><div class="line">	<span class="keyword">if</span> claims, ok := token1.Claims.(jwt.MapClaims); ok &amp;&amp; token1.Valid &#123;</div><div class="line">		<span class="keyword">return</span> fmt.Sprintf(<span class="string">"%v"</span>, claims[<span class="string">"key"</span>]), <span class="literal">nil</span></div><div class="line">	&#125; <span class="keyword">else</span> &#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">""</span>, err</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Auth中间件就可以变成下面的样子：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Auth</span><span class="params">(inner http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">	    cookie, err := r.Cookie(<span class="string">"token"</span>)</div><div class="line">	    <span class="keyword">if</span> err != <span class="literal">nil</span> || cookie.Value == <span class="string">""</span>&#123;</div><div class="line">	        Response(w, <span class="string">"token not found."</span>, <span class="string">"AUTH_FAILED"</span>,<span class="number">403</span>)</div><div class="line">	        <span class="keyword">return</span>;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    user_id, err := token.Valid(cookie.Value)</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	        Response(w, <span class="string">"bad token."</span>, <span class="string">"AUTH_FAILED"</span>,<span class="number">403</span>)</div><div class="line">	        <span class="keyword">return</span>;</div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    rows, res, err := db.Query(<span class="string">"select * from user where user_id= '%d'"</span>, user_id)</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">	        Response(w, <span class="string">"can not connect database."</span>, <span class="string">"DB_ERROR"</span>,<span class="number">500</span>)</div><div class="line">	        <span class="keyword">return</span></div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    <span class="keyword">if</span> <span class="built_in">len</span>(rows) == <span class="number">0</span> &#123;</div><div class="line">	    	Response(w, <span class="string">"user not found."</span>, <span class="string">"NOT_FOUND"</span>,<span class="number">404</span>)</div><div class="line">	    	<span class="keyword">return</span></div><div class="line">	    &#125;</div><div class="line"></div><div class="line">	    row := rows[<span class="number">0</span>]</div><div class="line"></div><div class="line">	    user := controllers.User&#123;</div><div class="line">	    		User_id:row.Int(res.Map(<span class="string">"user_id"</span>)), </div><div class="line">	    		User_name:row.Str(res.Map(<span class="string">"user_name"</span>)),</div><div class="line">	    		User_type:row.Str(res.Map(<span class="string">"user_type"</span>)),</div><div class="line">	    		Add_time:row.Str(res.Map(<span class="string">"add_time"</span>))&#125;</div><div class="line"></div><div class="line">	    session.CurrentUser = user</div><div class="line"></div><div class="line">	    log.Printf(<span class="string">"user_id:%v"</span>,controllers.CurrentUser.User_id)</div><div class="line">	    inner.ServeHTTP(w, r)</div><div class="line">	&#125;)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>我们还可以对每个URL实现log记录：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Logger</span><span class="params">(inner http.Handler, name <span class="keyword">string</span>)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">		start := time.Now()</div><div class="line">		inner.ServeHTTP(w, r)</div><div class="line"></div><div class="line">		log.Printf(</div><div class="line">			<span class="string">"%s\t%s\t%s\t%s"</span>,</div><div class="line">			r.Method,</div><div class="line">			r.RequestURI,</div><div class="line">			name,</div><div class="line">			time.Since(start),</div><div class="line">		)</div><div class="line">	&#125;)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRouter</span><span class="params">()</span> *<span class="title">mux</span>.<span class="title">Router</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> router == <span class="literal">nil</span> &#123;</div><div class="line">                router = mux.NewRouter().StrictSlash(<span class="literal">true</span>)</div><div class="line">        &#125;</div><div class="line">	<span class="keyword">for</span> _, route := <span class="keyword">range</span> routes &#123;</div><div class="line">		<span class="keyword">var</span> handler http.Handler = decorates.Logger(route.HandlerFunc, route.Name)</div><div class="line">		<span class="keyword">if</span>(route.Auth)&#123;</div><div class="line">			handler = decorates.Auth(handler)</div><div class="line">		&#125;</div><div class="line">		router.</div><div class="line">			Methods(route.Method).</div><div class="line">			Path(route.Pattern).</div><div class="line">			Name(route.Name).</div><div class="line">			Handler(handler)</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> router</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>有跨域的需求？好办：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CorsHeader</span><span class="params">(inner http.Handler)</span> <span class="title">http</span>.<span class="title">Handler</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line"></div><div class="line">    	    w.Header().Set(<span class="string">"Access-Control-Allow-Origin"</span>, r.Header.Get(<span class="string">"Origin"</span>))</div><div class="line">    	    w.Header().Set(<span class="string">"Access-Control-Allow-Credentials"</span>, <span class="string">"true"</span>)</div><div class="line">	    w.Header().Add(<span class="string">"Access-Control-Allow-Method"</span>,<span class="string">"POST, OPTIONS, GET, HEAD, PUT, PATCH, DELETE"</span>)</div><div class="line"></div><div class="line">	    w.Header().Add(<span class="string">"Access-Control-Allow-Headers"</span>,<span class="string">"Origin, X-Requested-With, X-HTTP-Method-Override,accept-charset,accept-encoding , Content-Type, Accept, Cookie"</span>)</div><div class="line"></div><div class="line">    	    w.Header().Set(<span class="string">"Content-Type"</span>,<span class="string">"application/json"</span>)</div><div class="line">		inner.ServeHTTP(w, r)</div><div class="line">	&#125;)</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRouter</span><span class="params">()</span> *<span class="title">mux</span>.<span class="title">Router</span></span> &#123;</div><div class="line">	<span class="keyword">if</span> router == <span class="literal">nil</span> &#123;</div><div class="line">        router = mux.NewRouter().StrictSlash(<span class="literal">true</span>)</div><div class="line">    &#125;</div><div class="line">	<span class="keyword">for</span> _, route := <span class="keyword">range</span> routes &#123;</div><div class="line">		<span class="keyword">var</span> handler http.Handler = decorates.Logger(route.HandlerFunc, route.Name)</div><div class="line">		<span class="keyword">if</span>(route.Auth)&#123;</div><div class="line">			handler = decorates.Auth(handler)</div><div class="line">		&#125;</div><div class="line">		handler = decorates.CorsHeader(handler)</div><div class="line">		router.</div><div class="line">			Methods(route.Method).</div><div class="line">			Path(route.Pattern).</div><div class="line">			Name(route.Name).</div><div class="line">			Handler(handler)</div><div class="line">		router.</div><div class="line">			Methods(<span class="string">"OPTIONS"</span>).</div><div class="line">			Path(route.Pattern).</div><div class="line">			Name(<span class="string">"cors"</span>).</div><div class="line">			Handler(decorates.CorsHeader(http.HandlerFunc(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span></span> &#123;</div><div class="line">				<span class="keyword">return</span></div><div class="line">			&#125;)))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> router</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>session管理好像还有一些问题，每个request请求都会改变全局的CurrenUser，如果有并发的情况下，这就容易产生混乱了，可以需要用户信息的时候通过token去数据库来取，效率会有影响，但并发的问题可以解决了：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">CurrentUser</span><span class="params">(r *http.Request)</span> *<span class="title">models</span>.<span class="title">User</span></span> &#123;</div><div class="line">	cookie, err := r.Cookie(<span class="string">"token"</span>)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> || cookie.Value == <span class="string">""</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;models.User&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	key, err := token.Valid(cookie.Value)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;models.User&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">if</span> !strings.Contains(key, <span class="string">"|"</span>) &#123;</div><div class="line">		<span class="keyword">return</span> &amp;models.User&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	keys := strings.Split(key, <span class="string">"|"</span>)</div><div class="line">	rows, res, err := db.QueryNonLogging(<span class="string">"select * from user where user_id = '%v' and user_pass = '%v'"</span>, keys[<span class="number">0</span>], keys[<span class="number">1</span>])</div><div class="line"></div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;models.User&#123;&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">if</span> <span class="built_in">len</span>(rows) == <span class="number">0</span> &#123;</div><div class="line">		<span class="keyword">return</span> &amp;models.User&#123;&#125;</div><div class="line">	&#125;</div><div class="line">	row := rows[<span class="number">0</span>]</div><div class="line">	user := models.User&#123;</div><div class="line">		User_id:   row.Int(res.Map(<span class="string">"user_id"</span>)),</div><div class="line">		User_name: row.Str(res.Map(<span class="string">"user_name"</span>)),</div><div class="line">		User_type: row.Str(res.Map(<span class="string">"user_type"</span>)),</div><div class="line">		Add_time:  row.Str(res.Map(<span class="string">"add_time"</span>))&#125;</div><div class="line"></div><div class="line">	<span class="keyword">return</span> &amp;user</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>日志的问题好像还没有解决，毕竟日志需要写到文件里面并且需要一些详细的信息，比如行号，文件，才能利于排查问题，或者做统计：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Printf</span><span class="params">(format <span class="keyword">string</span>, params ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	_, f, line, _ := runtime.Caller(<span class="number">1</span>)</div><div class="line">	log.Printf(format, params...)</div><div class="line">	file, err := os.OpenFile(settings.LogFile, os.O_CREATE|os.O_APPEND|os.O_RDWR, os.ModePerm)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Printf(<span class="string">"%v"</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> file.Close()</div><div class="line">	_, err = file.Seek(<span class="number">0</span>, os.SEEK_END)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	args := strings.Split(f, <span class="string">"/"</span>)</div><div class="line">	f = args[<span class="built_in">len</span>(args)<span class="number">-1</span>]</div><div class="line">	msg := fmt.Sprintf(<span class="string">"%v:%v(%v)"</span>, line, format, f)</div><div class="line">	logger := log.New(file, <span class="string">""</span>, log.LstdFlags)</div><div class="line">	logger.Printf(msg, params...)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">Println</span><span class="params">(v ...<span class="keyword">interface</span>&#123;&#125;)</span></span> &#123;</div><div class="line">	_, f, line, _ := runtime.Caller(<span class="number">1</span>)</div><div class="line">	log.Println(v...)</div><div class="line">	file, err := os.OpenFile(settings.LogFile, os.O_CREATE|os.O_APPEND|os.O_RDWR, os.ModePerm)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		log.Printf(<span class="string">"%v"</span>, err)</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	<span class="keyword">defer</span> file.Close()</div><div class="line">	_, err = file.Seek(<span class="number">0</span>, os.SEEK_END)</div><div class="line">	<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">		<span class="keyword">return</span></div><div class="line">	&#125;</div><div class="line">	args := strings.Split(f, <span class="string">"/"</span>)</div><div class="line">	f = args[<span class="built_in">len</span>(args)<span class="number">-1</span>]</div><div class="line">	msg := fmt.Sprintf(<span class="string">"%v:%v(%v)"</span>, line, fmt.Sprintln(v...), f)</div><div class="line">	logger := log.New(file, <span class="string">""</span>, log.LstdFlags)</div><div class="line">	logger.Println(msg)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>日志写到文件的问题解决了，又面临新的问题，日志文件太大，怎么办，需要归档（每隔12小时就查看一下日志文件多大了，如果太大了就压缩一下归档）：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> ticker = time.NewTicker(time.Minute * <span class="number">60</span> * <span class="number">12</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">init</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">		<span class="keyword">for</span> _ = <span class="keyword">range</span> ticker.C &#123;</div><div class="line">			archive()</div><div class="line">		&#125;</div><div class="line">	&#125;()</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">archive</span><span class="params">()</span> <span class="title">error</span></span> &#123;</div><div class="line">	info, _ := os.Stat(settings.LogFile)</div><div class="line">	<span class="keyword">if</span> info.Size() &gt; <span class="number">1024</span>*<span class="number">1024</span>*<span class="number">50</span> &#123;</div><div class="line">		target := fmt.Sprintf(<span class="string">"%v.%v.tar.gz"</span>,</div><div class="line">			shortFileName(settings.LogFile),</div><div class="line">			time.Now().Format(<span class="string">"2006-01-02-15-04"</span>),</div><div class="line">		)</div><div class="line">		tmp := fmt.Sprintf(<span class="string">"%v.%v.tmp"</span>,</div><div class="line">			shortFileName(settings.LogFile),</div><div class="line">			time.Now().Format(<span class="string">"2006-01-02-15-04"</span>),</div><div class="line">		)</div><div class="line">		in := bytes.NewBuffer(<span class="literal">nil</span>)</div><div class="line">		cmd := exec.Command(<span class="string">"sh"</span>)</div><div class="line">		cmd.Stdin = in</div><div class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</div><div class="line">			in.WriteString(fmt.Sprintf(<span class="string">"cd %v\n"</span>, shortFileDir(settings.LogFile)))</div><div class="line">			in.WriteString(fmt.Sprintf(<span class="string">"cp %v %v\n"</span>, shortFileName(settings.LogFile), tmp))</div><div class="line">			in.WriteString(fmt.Sprintf(<span class="string">"echo '' &gt; %v\n"</span>, shortFileName(settings.LogFile)))</div><div class="line">			in.WriteString(fmt.Sprintf(<span class="string">"tar -czvf %v %v\n"</span>, target, tmp))</div><div class="line">			in.WriteString(fmt.Sprintf(<span class="string">"rm %v\n"</span>, tmp))</div><div class="line">			in.WriteString(<span class="string">"exit\n"</span>)</div><div class="line">		&#125;()</div><div class="line">		<span class="keyword">if</span> err := cmd.Run(); err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Println(err)</div><div class="line">			<span class="keyword">return</span> err</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>基本的功能好像都能解决了，饱暖思淫欲，错误处理感觉用起来不怎么舒服，有更优雅的办法：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">type</span> Handler <span class="function"><span class="keyword">func</span><span class="params">(http.ResponseWriter, *http.Request)</span> *<span class="title">models</span>.<span class="title">APPError</span></span></div><div class="line"></div><div class="line"><span class="title">func</span> <span class="params">(fn Handler)</span> <span class="title">ServeHTTP</span><span class="params">(w http.ResponseWriter, r *http.Request)</span> &#123;</div><div class="line">	<span class="keyword">if</span> e := fn(w, r); e != <span class="literal">nil</span> &#123;</div><div class="line">		utils.Response(w, e.Message, e.Code, e.Status)</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">//装饰器就变成了这样</span></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="params">(inner Handler)</span> <span class="title">Auth</span><span class="params">()</span> <span class="title">Handler</span></span> &#123;</div><div class="line">	<span class="keyword">return</span> Handler(<span class="function"><span class="keyword">func</span><span class="params">(w http.ResponseWriter, r *http.Request)</span> *<span class="title">models</span>.<span class="title">APPError</span></span> &#123;</div><div class="line">		tokenString := <span class="string">""</span></div><div class="line">		cookie, _ := r.Cookie(<span class="string">"token"</span>)</div><div class="line">		<span class="keyword">if</span> cookie != <span class="literal">nil</span> &#123;</div><div class="line">			tokenString = cookie.Value</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> tokenString == <span class="string">""</span> &#123;</div><div class="line">			<span class="keyword">if</span> r.Header != <span class="literal">nil</span> &#123;</div><div class="line">				<span class="keyword">if</span> authorization := r.Header[<span class="string">"Authorization"</span>]; <span class="built_in">len</span>(authorization) &gt; <span class="number">0</span> &#123;</div><div class="line">					tokenString = authorization[<span class="number">0</span>]</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">		key, err := token.Valid(tokenString)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> &amp;models.APPError&#123;err, <span class="string">"bad token."</span>, <span class="string">"AUTH_FAILED"</span>, <span class="number">403</span>&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> !strings.Contains(key, <span class="string">"|"</span>) &#123;</div><div class="line">			<span class="keyword">return</span> &amp;models.APPError&#123;err, <span class="string">"user not found."</span>, <span class="string">"NOT_FOUND"</span>, <span class="number">404</span>&#125;</div><div class="line">		&#125;</div><div class="line">		keys := strings.Split(key, <span class="string">"|"</span>)</div><div class="line">		rows, _, err := db.QueryNonLogging(<span class="string">"select * from user where user_id = '%v' and user_pass = '%v'"</span>, keys[<span class="number">0</span>], keys[<span class="number">1</span>])</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			<span class="keyword">return</span> &amp;models.APPError&#123;err, <span class="string">"can not connect database."</span>, <span class="string">"DB_ERROR"</span>, <span class="number">500</span>&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">if</span> <span class="built_in">len</span>(rows) == <span class="number">0</span> &#123;</div><div class="line">			<span class="keyword">return</span> &amp;models.APPError&#123;err, <span class="string">"user not found."</span>, <span class="string">"NOT_FOUND"</span>, <span class="number">404</span>&#125;</div><div class="line">		&#125;</div><div class="line">		<span class="keyword">go</span> log.Printf(<span class="string">"user_id:%v"</span>, keys[<span class="number">0</span>])</div><div class="line">		inner.ServeHTTP(w, r)</div><div class="line">		<span class="keyword">return</span> <span class="literal">nil</span></div><div class="line">	&#125;)</div><div class="line">&#125;</div><div class="line"><span class="comment">//router画风也变了</span></div><div class="line"><span class="keyword">type</span> Route <span class="keyword">struct</span> &#123;</div><div class="line">	Name        <span class="keyword">string</span></div><div class="line">	Method      <span class="keyword">string</span></div><div class="line">	Pattern     <span class="keyword">string</span></div><div class="line">	HandlerFunc Handler</div><div class="line">	ContentType <span class="keyword">string</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">type</span> Routes []Route</div><div class="line"><span class="keyword">var</span> BRoutes = Routes&#123;</div><div class="line">	Route&#123;</div><div class="line">		<span class="string">"nothing"</span>,</div><div class="line">		<span class="string">"GET"</span>,</div><div class="line">		<span class="string">"/"</span>,</div><div class="line">		Config,</div><div class="line">		contenttype.JSON,</div><div class="line">	&#125;,</div><div class="line">	Route&#123;</div><div class="line">		<span class="string">"authDemo"</span>,</div><div class="line">		<span class="string">"GET"</span>,</div><div class="line">		<span class="string">"/demo1"</span>,</div><div class="line">		Handler(Config).</div><div class="line">			Auth(),</div><div class="line">		contenttype.JSON,</div><div class="line">	&#125;,</div><div class="line">	Route&#123;</div><div class="line">		<span class="string">"verifyDemo"</span>,</div><div class="line">		<span class="string">"GET"</span>,</div><div class="line">		<span class="string">"/demo2"</span>,</div><div class="line">		Handler(Config).</div><div class="line">			Verify(),</div><div class="line">		contenttype.JSON,</div><div class="line">	&#125;,</div><div class="line">	Route&#123;</div><div class="line">		<span class="string">"verifyAndAuthDemo"</span>,</div><div class="line">		<span class="string">"GET"</span>,</div><div class="line">		<span class="string">"/demo3"</span>,</div><div class="line">		Handler(Config).</div><div class="line">			Auth().</div><div class="line">			Verify(),</div><div class="line">		contenttype.JSON,</div><div class="line">	&#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这样基本的web框架就完成了，想添加一些命令行工具，比如自动生成app，推荐用kingpin来实现：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> (</div><div class="line">	app      = kingpin.New(<span class="string">"beauty"</span>, <span class="string">"A command-line tools of beauty."</span>)</div><div class="line">	demo     = app.Command(<span class="string">"demo"</span>, <span class="string">"Demo of web server."</span>)</div><div class="line">	generate = app.Command(<span class="string">"generate"</span>, <span class="string">"Generate a new app."</span>)</div><div class="line">	name     = generate.Arg(<span class="string">"name"</span>, <span class="string">"AppName for app."</span>).Required().String()</div><div class="line">)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</div><div class="line">	<span class="keyword">switch</span> kingpin.MustParse(app.Parse(os.Args[<span class="number">1</span>:])) &#123;</div><div class="line">	<span class="keyword">case</span> generate.FullCommand():</div><div class="line">		GOPATH := os.Getenv(<span class="string">"GOPATH"</span>)</div><div class="line">		appPath := fmt.Sprintf(<span class="string">"%v/src/%v"</span>, GOPATH, *name)</div><div class="line">		origin := fmt.Sprintf(<span class="string">"%v/src/github.com/yang-f/beauty/etc/demo.zip"</span>, GOPATH)</div><div class="line">		dst := fmt.Sprintf(<span class="string">"%v.zip"</span>, appPath)</div><div class="line">		_, err := utils.CopyFile(dst, origin)</div><div class="line">		<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</div><div class="line">			fmt.Println(err.Error())</div><div class="line">		&#125;</div><div class="line">		utils.Unzip(dst, appPath)</div><div class="line">		os.RemoveAll(dst)</div><div class="line">		helper := utils.ReplaceHelper&#123;</div><div class="line">			Root:    appPath,</div><div class="line">			OldText: <span class="string">"&#123;appName&#125;"</span>,</div><div class="line">			NewText: *name,</div><div class="line">		&#125;</div><div class="line">		helper.DoWrok()</div><div class="line">		log.Printf(<span class="string">"Generate %s success."</span>, *name)</div><div class="line">	<span class="keyword">case</span> demo.FullCommand():</div><div class="line">		log.Printf(<span class="string">"Start server on port %s"</span>, settings.Listen)</div><div class="line">		router := router.NewRouter()</div><div class="line">		log.Fatal(http.ListenAndServe(settings.Listen, router))</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>执行beauty命令是这样的：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">usage: beauty [&lt;flags&gt;] &lt;<span class="built_in">command</span>&gt; [&lt;args&gt; ...]</div><div class="line"></div><div class="line">A <span class="built_in">command</span>-line tools of beauty.</div><div class="line"></div><div class="line">Flags:</div><div class="line">  --<span class="built_in">help</span>  Show context-sensitive <span class="built_in">help</span> (also try --<span class="built_in">help</span>-long and --<span class="built_in">help</span>-man).</div><div class="line"></div><div class="line">Commands:</div><div class="line">  <span class="built_in">help</span> [&lt;<span class="built_in">command</span>&gt;...]</div><div class="line">    Show <span class="built_in">help</span>.</div><div class="line"></div><div class="line">  demo</div><div class="line">    Demo of web server.</div><div class="line"></div><div class="line">  generate &lt;name&gt;</div><div class="line"></div><div class="line">    Generate a new app.</div></pre></td></tr></table></figure></p>
<p>到此，这个框架还在不断的优化中，希望能有人提供宝贵的批评和建议。</p>
<p>以下是代码地址：</p>
<p><a href="https://github.com/yang-f/beauty" target="_blank" rel="external">yang-f/beauty</a></p>
<p>谢谢！</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://nishihouziqinglaidedoubima.github.io/2017/07/04/实现简单go-web框架/" data-id="cjsg0fwsl000s2kvvx5t850eq" class="article-share-link">Partager</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/framework/">framework</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/golang/">golang</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/rest/">rest</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/web/">web</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/07/05/github-io博客绑定的域名总被置空/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Récent</strong>
      <div class="article-nav-title">
        
          github.io博客绑定的域名总被置空
        
      </div>
    </a>
  
  
    <a href="/2017/07/04/纯扯淡/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">纯扯淡</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Catégories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/技术/">技术</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/ARC/">ARC</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/CNAME/">CNAME</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Charles/">Charles</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Microservices/">Microservices</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Object-C/">Object C</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Xcode/">Xcode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/avframe/">avframe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/block/">block</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/c/">c++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/decode/">decode</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ffmpeg/">ffmpeg</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/frame/">frame</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/framework/">framework</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/golang/">golang</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iOS/">iOS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/keyframe/">keyframe</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/object-c/">object-c</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/oc/">oc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rest/">rest</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rgba/">rgba</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/web/">web</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/内存管理/">内存管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/压缩/">压缩</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/图片/">图片</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/多线程/">多线程</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/ARC/" style="font-size: 10px;">ARC</a> <a href="/tags/CNAME/" style="font-size: 10px;">CNAME</a> <a href="/tags/Charles/" style="font-size: 10px;">Charles</a> <a href="/tags/Microservices/" style="font-size: 10px;">Microservices</a> <a href="/tags/Object-C/" style="font-size: 15px;">Object C</a> <a href="/tags/Xcode/" style="font-size: 15px;">Xcode</a> <a href="/tags/avframe/" style="font-size: 10px;">avframe</a> <a href="/tags/block/" style="font-size: 10px;">block</a> <a href="/tags/c/" style="font-size: 10px;">c</a> <a href="/tags/c/" style="font-size: 20px;">c++</a> <a href="/tags/decode/" style="font-size: 10px;">decode</a> <a href="/tags/ffmpeg/" style="font-size: 15px;">ffmpeg</a> <a href="/tags/frame/" style="font-size: 10px;">frame</a> <a href="/tags/framework/" style="font-size: 15px;">framework</a> <a href="/tags/golang/" style="font-size: 15px;">golang</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/keyframe/" style="font-size: 10px;">keyframe</a> <a href="/tags/object-c/" style="font-size: 10px;">object-c</a> <a href="/tags/oc/" style="font-size: 10px;">oc</a> <a href="/tags/rest/" style="font-size: 15px;">rest</a> <a href="/tags/rgba/" style="font-size: 10px;">rgba</a> <a href="/tags/web/" style="font-size: 15px;">web</a> <a href="/tags/内存管理/" style="font-size: 10px;">内存管理</a> <a href="/tags/压缩/" style="font-size: 10px;">压缩</a> <a href="/tags/图片/" style="font-size: 10px;">图片</a> <a href="/tags/多线程/" style="font-size: 10px;">多线程</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/02/">February 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2019/02/22/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2019/02/19/你踩着月亮了/">你踩着月亮了</a>
          </li>
        
          <li>
            <a href="/2018/02/10/Golang-bool-计算器/">Golang bool 计算器</a>
          </li>
        
          <li>
            <a href="/2017/08/11/多线程解码/">多线程解码</a>
          </li>
        
          <li>
            <a href="/2017/08/09/改变四通道图片的宽高，节省内存开销/">改变四通道图片的宽高，节省内存开销</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2019 FLYING<br>
      Propulsé by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>